{% load static %}
{% load crispy_forms_tags %}
{% load humanize %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/home.css' %}">
{% endblock %}
<!-- Mensajes -->
{% if messages %}
<div class="alert-container"style="
    z-index: 99999;
    position: fixed;
    margin-left: 40%;
    width: 30%;">

    {% for message in messages %}
    <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert" style="background-color: #eb1212ff; color: #f5f5f5ff;">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endfor %}
</div>
{% endif %}

<!-- CONTENEDOR PRINCIPAL -->
<div class="main-container">
  <div class="content-row"  style= "width: 100% ;">

    <!-- SIDEBAR -->
    <nav id="sidebar" class="sidebar" style="position: fixed ;height: 100% ;">
      <div class="sidebar-brand">
        <h5 class="mb-2">
          <i class="fas fa-warehouse me-2"></i>{{ empresa.nombre }}
        </h5>
        <h5 class="mb-2">
         <i class="fas fa-id-card me-1"></i> {{ empresa.rut }}
        </h5>
        <h5 class="mb-2">
          <i class="fas fa-map-marker-alt me-1"></i> {{ empresa.direccion|truncatechars:20 }}
        </h5>
        <h5 class="mb-2">
          <i class="fas fa-phone me-1"></i> {{ empresa.telefono }}
        </h5>
        <small class="text-light opacity-75">M칩dulo de Gesti칩n de Stock</small>
        <div class="mt-3">
          
        </div>
      </div>
     
      
      <div class="flex-grow-1">
        <ul class="nav flex-column">
          <li class="nav-item mb-2">
            <button class="btn sidebar-btn {% if active_panel == 'dashboard' or not active_panel %}active{% endif %}" data-target="#panel-dashboard">
              <i class="fas fa-chart-line"></i>Resumen
            </button>
          </li>
          <!-- NUEVO BOT칍N GR츼FICOS -->
          <li class="nav-item mb-2">
            <button class="btn sidebar-btn {% if active_panel == 'graficos' %}active{% endif %}" data-target="#panel-graficos">
              <i class="fas fa-chart-bar"></i> Gr치ficos
            </button>
          </li>
          <li class="nav-item mb-2">
            <button class="btn sidebar-btn {% if active_panel == 'ingreso' %}active{% endif %}" data-target="#panel-ingreso">
              <i class="fas fa-arrow-down"></i>Ingreso de Stock
            </button>
          </li>
          <li class="nav-item mb-2">
            <button class="btn sidebar-btn {% if active_panel == 'egreso' %}active{% endif %}" data-target="#panel-egreso">
              <i class="fas fa-arrow-up"></i>Egreso de Stock
            </button>
          </li>
          
          {% if request.user.role == 'bodeguero' or request.user.role == 'admin' %}
          <li class="nav-item mb-2">
            <button class="btn sidebar-btn {% if active_panel == 'centro' %}active{% endif %}" data-target="#panel-centro">
              <i class="fas fa-truck"></i>Proveedores
            </button>
          </li>
          <li class="nav-item mb-2">
            <button class="btn sidebar-btn {% if active_panel == 'concepto-ingreso' %}active{% endif %}" data-target="#panel-concepto-ingreso">
              <i class="fas fa-box"></i>Productos
            </button>
          </li>
          <li class="nav-item mb-2">
            <button class="btn sidebar-btn {% if active_panel == 'concepto-egreso' %}active{% endif %}" data-target="#panel-concepto-egreso">
              <i class="fas fa-shopping-cart"></i>Pedidos
            </button>
          </li>
          <li class="nav-item mb-2">
            <button class="btn sidebar-btn {% if active_panel == 'lista-pedidos' %}active{% endif %}" data-target="#panel-lista-pedidos">
              <i class="fas fa-shopping-cart"></i>Lista Pedidos
            </button>
          </li>
          <li class="nav-item mb-2">
            <button class="btn sidebar-btn {% if active_panel == 'rcv' %}active{% endif %}" data-target="#panel-rcv">
              <i class="fas fa-file-alt"></i>Reportes
            </button>
          </li>
          {% endif %}
          {% if request.user.role == 'admin' %}
          <li class="nav-item mb-2">
            <button class="btn sidebar-btn {% if active_panel == 'parametros-sii' %}active{% endif %}" data-target="#panel-parametros-sii">
              <i class="fas fa-users"></i>Usuarios
            </button>
          </li>
          {% endif %}
          <li>
            <a href="{% url 'logout' %}" class="btn sidebar-btn">
              <i class="fas fa-sign-out-alt"></i>Cerrar Sesi칩n
            </a>
          </li>
        </ul>
        
      </div>
    </nav>

    <!-- MAIN CONTENT -->
    <main class="main-content" style=" width: 100%;">

      <!-- DASHBOARD -->
      <div id="panel-dashboard" class="panel {% if active_panel != 'dashboard' %}d-none{% endif %}">
        <div class="dashboard-grid">

          <!-- IZQUIERDA -->
          <div class="dashboard-main">
            <h3 class="form-section-title mb-4">Resumen General</h3>

            <!-- TARJETAS -->
            <div class="row mb-5" style="justify-content: space-between;">
              <div class="col-md-3 mb-3">
                <div class="card stat-card">
                  <div class="stat-icon text-primary"><i class="fas fa-boxes"></i></div>
                  <div class="stat-value">{{ total_productos }}</div>
                  <div class="stat-label">Productos</div>
                </div>
              </div>
              <div class="col-md-3 mb-3">
                <div class="card stat-card">
                  <div class="stat-icon text-warning"><i class="fas fa-exclamation-triangle"></i></div>
                  <div class="stat-value">{{ stock_bajo }}</div>
                  <div class="stat-label">Stock Bajo</div>
                </div>
              </div>
              <div class="col-md-3 mb-3">
                <div class="card stat-card">
                  <div class="stat-icon text-success"><i class="fas fa-dollar-sign"></i></div>
                  <div class="stat-value">${{ ganancia_real|intcomma }}</div>
                  <div class="stat-label">Ganancia Real</div>
                </div>
              </div>
              <div class="col-md-3 mb-3">
                <div class="card stat-card">
                  <div class="stat-icon text-info"><i class="fas fa-chart-line"></i></div>
                  <div class="stat-value">${{ ganancia_estimada_total|intcomma }}</div>
                  <div class="stat-label">Ganancia Potencial</div>
                </div>
              </div>
              <div class="col-md-3 mb-3">
                <div class="card stat-card">
                  <div class="stat-icon text-secondary"><i class="fas fa-lock"></i></div>
                  <div class="stat-value">{{ total_reservado|intcomma }}</div>
                  <div class="stat-label">Stock Reservado</div>
                </div>
              </div>
              <div class="col-md-3 mb-3">
                <div class="card stat-card">
                  <div class="stat-icon text-primary"><i class="fas fa-box-open"></i></div>
                  <div class="stat-value">{{ total_disponible|intcomma }}</div>
                  <div class="stat-label">Stock Disponible</div>
                </div>
              </div>
            </div>

            <!-- GR츼FICOS -->
            

            <!-- MOVIMIENTOS RECIENTES -->
            <div class="card mb-4">
              <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fas fa-exchange-alt me-2"></i>칔ltimos Movimientos</h5>
              </div>
              <div class="card-body p-0">
                <div class="table-responsive">
                  <table class="table table-hover mb-0">
                    <thead class="table-light">
                      <tr>
                        <th>Fecha</th>
                        <th>Producto</th>
                        <th>Tipo</th>
                        <th>Cantidad</th>
                        <th>Valor</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for t in ultimos_movimientos %}
                      <tr>
                        <td>{{ t.fecha|date:"d/m H:i" }}</td>
                        <td><strong>{{ t.inventario.producto.nombre }}</strong></td>
                        <td>
                          {% if t.tipo == 'ingreso' %}
                          <span class="badge bg-success">Ingreso</span>
                          {% else %}
                          <span class="badge bg-danger">Egreso</span>
                          {% endif %}
                        </td>
                        <td>{{ t.cantidad|intcomma }}</td>
                        <td>
                          {% if t.tipo == 'ingreso' %}
                          <span class="text-success">+${{ t.valor_display|intcomma }}</span>
                          {% else %}
                          <span class="text-danger">${{ t.valor_display|intcomma }}</span>
                          {% endif %}
                        </td>
                      </tr>
                      {% empty %}
                      <tr><td colspan="5" class="text-center py-4 text-muted">No hay movimientos</td></tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>

                <!-- Paginaci칩n de movimientos -->
                {% if ultimos_movimientos.has_other_pages %}
                <div class="card-footer bg-light">
                  <nav aria-label="Paginaci칩n movimientos">
                    <ul class="pagination pagination-sm justify-content-center mb-0">
                      {% if ultimos_movimientos.has_previous %}
                        <li class="page-item">
                          <a class="page-link" href="?panel=dashboard&page_mov={{ ultimos_movimientos.previous_page_number }}{% if page_inv %}&page_inv={{ page_inv }}{% endif %}">Anterior</a>
                        </li>
                      {% else %}
                        <li class="page-item disabled"><span class="page-link">Anterior</span></li>
                      {% endif %}

                      {% for num in ultimos_movimientos.paginator.page_range %}
                        {% if ultimos_movimientos.number == num %}
                          <li class="page-item active"><span class="page-link">{{ num }}</span></li>
                        {% else %}
                          <li class="page-item">
                            <a class="page-link" href="?panel=dashboard&page_mov={{ num }}{% if page_inv %}&page_inv={{ page_inv }}{% endif %}">{{ num }}</a>
                          </li>
                        {% endif %}
                      {% endfor %}

                      {% if ultimos_movimientos.has_next %}
                        <li class="page-item">
                          <a class="page-link" href="?panel=dashboard&page_mov={{ ultimos_movimientos.next_page_number }}{% if page_inv %}&page_inv={{ page_inv }}{% endif %}">Siguiente</a>
                        </li>
                      {% else %}
                        <li class="page-item disabled"><span class="page-link">Siguiente</span></li>
                      {% endif %}
                    </ul>
                  </nav>
                </div>
                {% endif %}
              </div>
            </div>

            <!-- INVENTARIO -->
            <div class="table-container">
              <h5 class="form-section-title mb-4">Inventario Actual</h5>
              <div class="table-responsive">
                <table class="table table-hover">
                  <thead class="table-dark">
                    <tr>
                      <th>Producto</th>
                      <th>Cantidad Total</th>
                      <th>Reservado</th>
                      <th>Disponible</th>
                      <th>Stock M칤n.</th>
                      <th>Costo Total</th>
                      <th>Ganancia Potencial</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for inv in inventarios %}
                    <tr class="{% if inv.disponible < inv.stock_minimo %}table-danger{% endif %}">
                      <td><strong>{{ inv.producto.nombre }}</strong></td>
                      <td>{{ inv.cantidad|intcomma }}</td>
                      <td>{{ inv.stock_reservado|intcomma }}</td>
                      <td>{{ inv.disponible|intcomma }}</td>
                      <td>{{ inv.stock_minimo|intcomma }}</td>
                      <td>${{ inv.val|intcomma }}</td>
                      <td class="text-success fw-bold">${{ inv.ganancia_estimada|intcomma }}</td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="7" class="text-center py-4 text-muted">No hay productos en inventario</td></tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>
            <!-- Paginaci칩n de inventario -->
            {% if inventarios.has_other_pages %}
            <nav aria-label="Paginaci칩n inventario" class="mt-3">
              <ul class="pagination justify-content-center">
                {% if inventarios.has_previous %}
                  <li class="page-item">
                    <a class="page-link" href="?panel=dashboard&page_inv={{ inventarios.previous_page_number }}{% if page_mov %}&page_mov={{ page_mov }}{% endif %}">Anterior</a>
                  </li>
                {% else %}
                  <li class="page-item disabled"><span class="page-link">Anterior</span></li>
                {% endif %}

                {% for num in inventarios.paginator.page_range %}
                  {% if inventarios.number == num %}
                    <li class="page-item active"><span class="page-link">{{ num }}</span></li>
                  {% else %}
                    <li class="page-item">
                      <a class="page-link" href="?panel=dashboard&page_inv={{ num }}{% if page_mov %}&page_mov={{ page_mov }}{% endif %}">{{ num }}</a>
                    </li>
                  {% endif %}
                {% endfor %}

                {% if inventarios.has_next %}
                  <li class="page-item">
                    <a class="page-link" href="?panel=dashboard&page_inv={{ inventarios.next_page_number }}{% if page_mov %}&page_mov={{ page_mov }}{% endif %}">Siguiente</a>
                  </li>
                {% else %}
                  <li class="page-item disabled"><span class="page-link">Siguiente</span></li>
                {% endif %}
              </ul>
            </nav>
            {% endif %}
          </div>

          <!-- DERECHA: RESUMEN R츼PIDO -->
          <div class="dashboard-sidebar-right">
            <div class="sticky-top" style="top:20px;">
              <h5 class="sidebar-title"><i class="fas fa-clipboard-list me-2"></i>Resumen R치pido</h5>
              <div class="summary-card mb-4">
                <h6 class="text-primary mb-3">Stock Actual</h6>
                <div class="summary-list">
                  {% for inv in inventarios %}
                  <div class="summary-item">
                    <span class="product-name">{{ inv.producto.nombre }}</span>
                    <span class="badge bg-primary">{{ inv.disponible|intcomma }} und. (Reservado: {{ inv.stock_reservado|intcomma }})</span>
                  </div>
                  {% endfor %}
                </div>
              </div>
              <div class="summary-card">
                <h6 class="text-success mb-3">Ganancia Potencial</h6>
                <div class="summary-list">
                  {% for inv in inventarios %}
                  <div class="summary-item">
                    <span class="product-name">{{ inv.producto.nombre }}</span>
                    <span class="badge bg-success">${{ inv.ganancia_estimada|intcomma }}</span>
                  </div>
                  {% endfor %}
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- ==================== NUEVO PANEL GR츼FICOS ==================== -->
      <div id="panel-graficos" class="panel {% if active_panel != 'graficos' %}d-none{% endif %}" style="width:95%;margin:0 auto;">
        <h3 class="form-section-title text-center mb-5"><i class="fas fa-chart-bar me-3"></i>Gr치ficos de Gesti칩n</h3>

        <div class="row">
          <div class="col-lg-6 mb-4">
            <div class="card h-100 shadow-sm">
              <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fas fa-exchange-alt me-2"></i>Flujo de Movimientos - 칔ltimos 8 d칤as</h5>
              </div>
              <div class="card-body">
                <canvas id="movementsChart"></canvas>
              </div>
            </div>
          </div>

          <div class="col-lg-6 mb-4">
            <div class="card h-100 shadow-sm">
              <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="fas fa-dollar-sign me-2"></i>Ganancia Estimada por Producto</h5>
              </div>
              <div class="card-body">
                <canvas id="profitsChart"></canvas>
              </div>
            </div>
          </div>
        </div>
      </div>
       <!-- PANEL: Ingreso de Stock -->  

      <div id="panel-ingreso" class="panel {% if active_panel != 'ingreso' %}d-none{% endif %}"
      style=>
        <div class="form-container">
          <h3 class="form-section-title">Ingreso de Stock</h3>
          <form method="post" id="form-ingreso" class="compact-form">
            {% csrf_token %}
            <input type="hidden" name="form_type" value="ingreso">
           
            {{ stock_entry_form|crispy }}
            <div class="d-flex justify-content-end mt-4">
              <button class="btn btn-success btn-action" type="submit">
                <i class="fas fa-plus-circle me-2"></i>Registrar Ingreso
              </button>
            </div>
            
          </form>
        </div>
      </div>

      <!-- PANEL: Egreso de Stock -->
      <div id="panel-egreso" class="panel {% if active_panel != 'egreso' %}d-none{% endif %}" style="width: 90%; max-width: 600px; margin: 0 auto;">
        <div class="form-container text-center">
          <h3 class="form-section-title mb-4">Egreso de Stock - Completar Pedido</h3>
          
          <div class="alert alert-info">
            <i class="fas fa-qrcode fa-2x mb-3"></i>
            <h5>Escanea el QR del pedido</h5>
            <p>Pulsa el bot칩n para activar la c치mara y apunta al c칩digo QR del pedido.</p>
          </div>

          <!-- Bot칩n grande para iniciar esc치ner -->
          <button id="start-scanner-btn" class="btn btn-success btn-lg mb-4">
            <i class="fas fa-camera fa-2x"></i><br>
            Iniciar Esc치ner QR
          </button>

          <!-- 츼rea donde aparecer치 la c치mara -->
          <div id="qr-reader" style="width: 100%; max-width: 500px; margin: 0 auto; display: none;"></div>
          <div id="qr-reader-results" class="mt-3"></div>

          <!-- Formulario manual como fallback -->
          <div class="mt-5 p-4 border rounded bg-light">
            <h5 class="mb-3">O usa el formulario manual</h5>
            <form method="post" class="compact-form">
              {% csrf_token %}
              <input type="hidden" name="form_type" value="egreso">
              {{ stock_exit_form|crispy }}
              <div class="d-flex justify-content-end mt-4">
                <button class="btn btn-danger btn-action" type="submit">
                  <i class="fas fa-minus-circle me-2"></i>Registrar Egreso Manual
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <!-- PANEL: Proveedores -->
      <div id="panel-centro" class="panel {% if active_panel != 'centro' %}d-none{% endif %}"
      >
        <div class="form-container">
          <h3 class="form-section-title">Nuevo Proveedor</h3>
          <form method="post" class="compact-form">
          {% if form.errors %}
            <div class="alert alert-danger">
                <ul>
                    {% for field in form %}
                        {% for error in field.errors %}
                            <li>{{ field.label }}: {{ error }}</li>
                        {% endfor %}
                    {% endfor %}
                    {% for error in form.non_field_errors %}
                        <li>{{ error }}</li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}
            {% csrf_token %}
            <input type="hidden" name="form_type" value="proveedor">
            {% if proveedor_form.instance.pk %}
            <input type="hidden" name="pk" value="{{ proveedor_form.instance.pk }}">
            {% endif %}
            {{ proveedor_form|crispy }}
            <div class="d-flex justify-content-end mt-4">
              <button class="btn btn-secondary btn-action" type="submit">
                <i class="fas fa-plus-circle me-2"></i>{% if proveedor_form.instance.pk %}Actualizar{% else %}Crear{% endif %} Proveedor
              </button>
            </div>
          </form>
          <div class="table-container mt-4">
            <h5 class="form-section-title mb-4">Proveedores Existentes</h5>
            {% if proveedores %}
            <div class="table-responsive">
              <table class="table table-striped">
                <thead>
                  <tr>
                    <th>Nombre</th>
                    <th>Contacto</th>
                    <th>Email</th>
                    <th>Tel칠fono</th>
                    <th>Acciones</th>
                  </tr>
                </thead>
                <tbody>
                  {% for prov in proveedores %}
                  <tr>
                    <td>{{ prov.nombre }}</td>
                    <td>{{ prov.contacto }}</td>
                    <td>{{ prov.email }}</td>
                    <td>{{ prov.telefono }}</td>
                    <td>
                      <a href="?panel=centro&edit_proveedor={{ prov.pk }}" class="btn btn-warning btn-sm">Editar</a>
                      <form method="post" class="d-inline">
                        {% csrf_token %}
                        <input type="hidden" name="form_type" value="delete_proveedor">
                        <input type="hidden" name="pk" value="{{ prov.pk }}">
                        <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('쮼st치s seguro de que quieres eliminar ?');">Eliminar</button>
                      </form>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
            {% else %}
            <div class="empty-state">
              <i class="fas fa-truck"></i>
              <p class="mt-3">No hay proveedores registrados</p>
            </div>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- PANEL: Productos -->
      <div id="panel-concepto-ingreso" class="panel {% if active_panel != 'concepto-ingreso' %}d-none{% endif %}"
      >
        <div class="form-container">
          <h3 class="form-section-title">Nuevo Producto</h3>
          <form method="post" class="compact-form">
           {% if form.errors %}
            <div class="alert alert-danger">
                <ul>
                    {% for field in form %}
                        {% for error in field.errors %}
                            <li>{{ field.label }}: {{ error }}</li>
                        {% endfor %}
                    {% endfor %}
                    {% for error in form.non_field_errors %}
                        <li>{{ error }}</li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}
            {% csrf_token %}
            <input type="hidden" name="form_type" value="producto">
            {% if producto_form.instance.pk %}
            <input type="hidden" name="pk" value="{{ producto_form.instance.pk }}">
            {% endif %}
            {{ producto_form|crispy }}
            <div class="d-flex justify-content-end mt-4">
              <button class="btn btn-secondary btn-action" type="submit">
                <i class="fas fa-plus-circle me-2"></i>{% if producto_form.instance.pk %}Actualizar{% else %}Crear{% endif %} Producto
              </button>
            </div>
          </form>
          <div class="table-container mt-4">
            <h5 class="form-section-title mb-4">Productos Existentes</h5>
            {% if productos %}
            <div class="table-responsive">
              <table class="table table-striped">
                <thead>
                  <tr>
                    <th>Nombre</th>
                    <th>Descripci칩n</th>
                    <th>Unidad</th>
                    <th>Precio Costo</th>
                    <th>Precio Venta</th>
                    <th>Acciones</th>
                  </tr>
                </thead>
                <tbody>
                  {% for prod in productos %}
                  <tr>
                    <td>{{ prod.nombre }}</td>
                    <td>{{ prod.descripcion|truncatechars:30 }}</td>
                    <td>{{ prod.unidad }}</td>
                    <td>${{ prod.precio_unitario|intcomma }}</td>
                    <td>${{ prod.precio_venta|intcomma }}</td>
                    <td>
                      <a href="?panel=concepto-ingreso&edit_producto={{ prod.pk }}" class="btn btn-warning btn-sm">Editar</a>
                      <form method="post" class="d-inline">
                        {% csrf_token %}
                        <input type="hidden" name="form_type" value="delete_producto">
                        <input type="hidden" name="pk" value="{{ prod.pk }}">
                        <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('쮼st치s seguro de que quieres eliminar ?');">Eliminar</button>
                      </form>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
            {% else %}
            <div class="empty-state">
              <i class="fas fa-box"></i>
              <p class="mt-3">No hay productos registrados</p>
            </div>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- PANEL: Pedidos -->
      <div id="panel-concepto-egreso" class="panel {% if active_panel != 'concepto-egreso' %}d-none{% endif %}" >
        <div class="form-container">
          <h3 class="form-section-title">Nuevo Pedido</h3>
          <form method="post" class="compact-form">
            {% csrf_token %}
            <input type="hidden" name="form_type" value="pedido">
            {% if pedido_form.instance.pk %}
            <input type="hidden" name="pk" value="{{ pedido_form.instance.pk }}">
            {% endif %}
            {% if pedido_form.errors %}
            <div class="alert alert-danger">
                <ul>
                    {% for field in pedido_form %}
                        {% for error in field.errors %}
                            <li>{{ field.label }}: {{ error }}</li>
                        {% endfor %}
                    {% endfor %}
                    {% for error in pedido_form.non_field_errors %}
                        <li>{{ error }}</li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}
            {{ pedido_form|crispy }}
            
            <!-- Render del formset para 칤tems -->
            <h5>칈tems del Pedido</h5>
            {{ pedido_item_formset.management_form }}
            <div id="item-forms">
              {% for form in pedido_item_formset %}
                <div class="form-row mb-3">
                  {{ form|crispy }}
                </div>
              {% endfor %}
            </div>
            
            <!-- Bot칩n para a침adir 칤tem -->
            <button type="button" id="add-item" class="btn btn-secondary mb-3">A침adir 칈tem</button>
            
            <div class="d-flex justify-content-end mt-4">
              <button class="btn btn-secondary btn-action" type="submit">
                <i class="fas fa-plus-circle me-2"></i>{% if pedido_form.instance.pk %}Actualizar{% else %}Crear{% endif %} Pedido
              </button>
            </div>
          </form>
          <div class="table-container mt-4">
            <h5 class="form-section-title mb-4">Pedidos Existentes</h5>
            {% if pedidos %}
            <div class="table-responsive">
              <table class="table table-striped">
                <thead>
                  <tr>
                    <th>Proveedor</th>
                    <th>Producto(s)</th>
                    <th>Cantidad(es)</th>
                    <th>Fecha Pedido</th>
                    <th>Fecha Vencimiento</th>
                    <th>Estado</th>
                    <th>Acciones</th>
                  </tr>
                </thead>
                <tbody>
                  {% for ped in pedidos %}
                  <tr class="{% if ped.esta_vencido %}table-danger{% endif %}">
                    <td>{{ ped.proveedor.nombre }}</td>
                    <td>
                      <ul>
                        {% for item in ped.items.all %}
                        <li>{{ item.producto.nombre }}</li>
                        {% endfor %}
                      </ul>
                    </td>
                    <td>
                      <ul>
                        {% for item in ped.items.all %}
                        <li>{{ item.cantidad|intcomma }}</li>
                        {% endfor %}
                      </ul>
                    </td>
                    <td>{{ ped.fecha_pedido|date:"d/m/Y" }}</td>
                    <td>{{ ped.fecha_vencimiento|date:"d/m/Y"|default:"-" }}</td>
                    <td>{{ ped.estado }}</td>
                    <td>
                      <a href="?panel=concepto-egreso&edit_pedido={{ ped.pk }}" class="btn btn-warning btn-sm">Editar</a>
                      <form method="post" class="d-inline">
                        {% csrf_token %}
                        <input type="hidden" name="form_type" value="delete_pedido">
                        <input type="hidden" name="pk" value="{{ ped.pk }}">
                        <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('쮼st치s seguro de que quieres eliminar ?');">Eliminar</button>
                      </form>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
            {% else %}
            <div class="empty-state">
              <i class="fas fa-shopping-cart"></i>
              <p class="mt-3">No hay pedidos registrados</p>
            </div>
            {% endif %}
          </div>
        </div>
      </div>
      <!-- PANEL: Lista de Pedidos (Nuevo) -->
      <div id="panel-lista-pedidos" class="panel {% if active_panel != 'lista-pedidos' %}d-none{% endif %}"
      >
        <h3 class="form-section-title mb-4">Lista de Pedidos</h3>
        <!-- Filtros -->
        <form method="get" class="row g-3 mb-4">
          <div class="col-md-3">
            <label>Estado</label>
            <select name="estado" class="form-control">
              <option value="">Todos</option>
              {% for estado in Pedido.ESTADOS %}
              <option value="{{ estado.0 }}" {% if request.GET.estado == estado.0 %}selected{% endif %}>{{ estado.1 }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-3">
            <label>Proveedor</label>
            <select name="proveedor" class="form-control">
              <option value="">Todos</option>
              {% for prov in proveedores %}
              <option value="{{ prov.id }}" {% if request.GET.proveedor == prov.id|stringformat:"s" %}selected{% endif %}>{{ prov.nombre }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-3">
            <label>Desde</label>
            <input type="date" name="fecha_desde" value="{{ request.GET.fecha_desde }}" class="form-control">
          </div>
          <div class="col-md-3">
            <label>Hasta</label>
            <input type="date" name="fecha_hasta" value="{{ request.GET.fecha_hasta }}" class="form-control">
          </div>
          <div class="col-md-12">
            <button type="submit" class="btn btn-primary">Filtrar</button>
          </div>
        </form>
        <!-- Tabla -->
        {% if pedidos %}
        <div class="table-responsive">
          <table class="table table-striped">
            <thead>
              <tr>
                <th>ID</th>
                <th>Proveedor</th>
                <th>Fecha Emisi칩n</th>
                <th>Estado</th>
                <th>칈tems</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody>
              {% for ped in pedidos %}
              <tr>
                <td>{{ ped.id }}</td>
                <td>{{ ped.proveedor.nombre }}</td>
                <td>{{ ped.fecha_pedido|date:"d/m/Y H:i" }}</td>
                <td>{{ ped.estado }}</td>
                <td>
                  <ul>
                    {% for item in ped.items.all %}
                    <li>{{ item.producto.nombre }}: {{ item.cantidad }}</li>
                    {% endfor %}
                  </ul>
                </td>
                <td>
                  <button class="btn btn-info btn-sm generate-qr" data-pk="{{ ped.pk }}">Generar QR</button>
                  <a href="#" class="btn btn-success btn-sm send-whatsapp" style="display:none; margin-left:5px;">
                    <i class="fab fa-whatsapp"></i> Enviar Link
                  </a>
                  <img class="qr-image" src="" alt="QR Code" style="display:none; max-width:150px; margin:10px 0;">
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% else %}
        <div class="empty-state">
          <i class="fas fa-list"></i>
          <p class="mt-3">No hay pedidos</p>
        </div>
        {% endif %}
      </div>
      <!-- PANEL: Reportes -->
      <div id="panel-rcv" class="panel {% if active_panel != 'rcv' %}d-none{% endif %}"
      >
        <h3 class="form-section-title mb-4">Generar Reporte</h3>
        <form method="post" class="compact-form mb-5">
          {% csrf_token %}
          <input type="hidden" name="form_type" value="reporte">
          <div class="row g-3">
            <div class="col-md-4">
              <div class="form-group">
                <label for="tipo">Tipo de Reporte</label>
                <select name="tipo" id="tipo" class="form-control">
                  <option value="Ingreso">Ingreso de Stock</option>
                  <option value="Egreso">Egreso de Stock</option>
                  <option value="Resumen">Resumen de Inventario</option>
                </select>
              </div>
            </div>
            <div class="col-md-4">
              <div class="form-group">
                <label for="fecha_desde">Desde</label>
                <input type="date" name="fecha_desde" id="fecha_desde" class="form-control">
              </div>
            </div>
            <div class="col-md-4">
              <div class="form-group">
                <label for="fecha_hasta">Hasta</label>
                <input type="date" name="fecha_hasta" id="fecha_hasta" class="form-control">
              </div>
            </div>
          </div>
          <div class="d-flex justify-content-end mt-3">
            <button type="submit" class="btn btn-primary">Generar Reporte</button>
          </div>
        </form>

        <h5 class="form-section-title mb-4">Reportes Generados</h5>
        {% if reportes %}
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>Tipo</th>
                        <th>Fecha Generaci칩n</th>
                        <th>Vista Previa</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for rep in reportes %}
                    <tr>
                        <td>
                            {% if rep.tipo == 'Ingreso' %}
                            <span class="badge bg-success">Ingreso</span>
                            {% elif rep.tipo == 'Egreso' %}
                            <span class="badge bg-danger">Egreso</span>
                            {% else %}
                            <span class="badge bg-primary">Resumen</span>
                            {% endif %}
                            {{ rep.tipo }}
                        </td>
                        <td>{{ rep.fecha|date:"d/m/Y H:i" }}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-info" type="button" data-bs-toggle="collapse" data-bs-target="#preview-{{ rep.id }}">
                                <i class="fas fa-eye"></i> Ver
                            </button>
                        </td>
                        <td>
                            <button onclick="downloadReport({{ rep.id }}, '{{ rep.tipo }}')" class="btn btn-sm btn-success">
                                <i class="fas fa-file-pdf"></i> Descargar PDF
                            </button>
                        </td>
                    </tr>
                    <tr>
                        <td colspan="4" class="p-0">
                            <div class="collapse" id="preview-{{ rep.id }}">
                                <div id="report-content-{{ rep.id }}" class="report-preview p-4 bg-light">
                                    {% include "report_template.html" with reporte=rep %}
                                </div>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="empty-state text-center py-5">
            <i class="fas fa-file-alt fa-3x text-muted mb-3"></i>
            <p class="text-muted">No hay reportes generados a칰n.<br>Usa el formulario superior para crear uno.</p>
        </div>
        {% endif %}
        </div>
      
      <!-- PANEL: Usuarios -->
        <div id="panel-parametros-sii" class="panel {% if active_panel != 'parametros-sii' %}d-none{% endif %}">
          <div class="form-container">
            <h3 class="form-section-title mb-4">
              <i class="fas fa-users text-warning me-2"></i> Registro de Usuarios
            </h3>
            <form method="post" class="compact-form">
              {% csrf_token %}
              <input type="hidden" name="form_type" value="usuario">
              {{ user_form|crispy }}
              <div class="d-flex justify-content-end mt-4">
                <button type="submit" class="btn btn-warning btn-lg px-5">
                  <i class="fas fa-save me-2"></i> Registrar Usuario
                </button>
              </div>
            </form>
            <div class="table-container mt-4">
              <h5 class="form-section-title mb-4">Usuarios Existentes</h5>
              {% if usuarios %}
              <ul class="centros-list">
                {% for user in usuarios %}
                <li>
                  <strong>{{ user.username }}</strong> - {{ user.role }}
                </li>
                {% endfor %}
              </ul>
              {% else %}
              <div class="empty-state">
                <i class="fas fa-users"></i>
                <p class="mt-3">No hay usuarios registrados</p>
              </div>
              {% endif %}
            </div>
          </div>
        </div>

    </main>

  
</div>

<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function () {
  
  // Variable para saber el panel activo (la pasamos desde Django)
  const activePanel = '{{ active_panel }}';  // <-- Ahora s칤 existe en JS

  // 1. L칩gica de pesta침as (Sidebar)
  const sidebarBtns = document.querySelectorAll('.sidebar-btn');
  sidebarBtns.forEach(btn => {
    btn.addEventListener('click', function () {
      document.querySelectorAll('.panel').forEach(p => p.classList.add('d-none'));
      const targetSelector = this.dataset.target;
      const targetPanel = document.querySelector(targetSelector);
      if (targetPanel) targetPanel.classList.remove('d-none');
      
      sidebarBtns.forEach(b => b.classList.remove('active'));
      this.classList.add('active');
    });
  });

  // 2. A침adir 칤tems al pedido (formset)
  const addItemBtn = document.getElementById('add-item');
  if (addItemBtn) {
    addItemBtn.addEventListener('click', function (e) {
      e.preventDefault();
      
      const formContainer = document.getElementById('item-forms');
      const totalForms = document.querySelector('[name="items-TOTAL_FORMS"]');
      
      if (!totalForms || !formContainer) return;

      const currentFormCount = parseInt(totalForms.value);
      const templateForm = formContainer.firstElementChild;
      if (!templateForm) return;

      const newForm = templateForm.cloneNode(true);
      newForm.innerHTML = newForm.innerHTML.replace(/items-\\d+-/g, `items-${currentFormCount}-`);
      
      newForm.querySelectorAll('input, select, textarea').forEach(input => {
        input.value = '';
        if (input.type === 'checkbox' || input.type === 'radio') input.checked = false;
      });

      formContainer.appendChild(newForm);
      totalForms.value = currentFormCount + 1;
    });
  }

  // 3. Gr치ficos
  if (typeof Chart !== 'undefined') {
    const ctxMovements = document.getElementById('movementsChart');
    if (ctxMovements) {
      new Chart(ctxMovements.getContext('2d'), {
        type: 'line',
        data: {
          labels: {{ stock_data.labels|safe }},
          datasets: [{
            label: 'Ingresos',
            data: {{ stock_data.ingresos|safe }},
            borderColor: 'rgba(75, 192, 192, 1)',
            backgroundColor: 'rgba(75, 192, 192, 0.2)',
          }, {
            label: 'Egresos',
            data: {{ stock_data.egresos|safe }},
            borderColor: 'rgba(255, 99, 132, 1)',
            backgroundColor: 'rgba(255, 99, 132, 0.2)',
          }]
        },
        options: { responsive: true }
      });
    }
    
    const ctxProfits = document.getElementById('profitsChart');
    if (ctxProfits) {
      new Chart(ctxProfits.getContext('2d'), {
        type: 'bar',
        data: {
          labels: {{ profits_data.labels|safe }},
          datasets: [{
            label: 'Ganancia Estimada',
            data: {{ profits_data.ganancias|safe }},
            backgroundColor: 'rgba(54, 162, 235, 0.2)',
            borderColor: 'rgba(54, 162, 235, 1)',
            borderWidth: 1
          }]
        },
        options: { responsive: true }
      });
    }
  }

  // 4. L칩gica de QR en lista de pedidos
  document.querySelectorAll('.generate-qr').forEach(btn => {
    btn.addEventListener('click', function () {
      const pk = this.dataset.pk;
      
      fetch(`/generar_qr/${pk}/`)
        .then(response => response.json())
        .then(data => {
          const row = this.closest('tr');
          const img = row.querySelector('.qr-image');
          const waBtn = row.querySelector('.send-whatsapp');
          
          if (img) {
            img.src = `data:image/png;base64,${data.qr_base64}`;
            img.style.display = 'block';
          }

          // Descarga autom치tica + alerta
          const downloadLink = document.createElement('a');
          downloadLink.href = `data:image/png;base64,${data.qr_base64}`;
          downloadLink.download = `QR_Pedido_${pk}.png`;
          document.body.appendChild(downloadLink);
          downloadLink.click();
          document.body.removeChild(downloadLink);

          alert(`춰QR del Pedido #${pk} descargado!\n\nEst치 en tu carpeta "Descargas" como:\nQR_Pedido_${pk}.png\n\nCuando abras WhatsApp:\n1. Elige el contacto\n2. Pulsa el clip 游늹\n3. Selecciona la imagen (est치 arriba del todo)\n4. Env칤a`);

          if (waBtn) {
            const urlPublica = `${window.location.origin}/pedido/${pk}/qr/`;
            const mensaje = encodeURIComponent(
                `춰Hola! Aqu칤 tienes el detalle de tu pedido #${pk}\n\n` +
                `Escanea el c칩digo QR para confirmar la entrega:\n\n` +
                urlPublica
            );

            waBtn.href = `https://wa.me/?text=${mensaje}`;
            waBtn.target = "_blank";
            waBtn.style.display = 'inline-block';
            waBtn.innerHTML = '<i class="fab fa-whatsapp"></i> Enviar Link por WhatsApp';
        }
        })
        .catch(err => {
          console.error("Error generando QR", err);
          alert("Error al generar el c칩digo QR");
        });
    });
  });

  // 5. Esc치ner QR para Egreso de Stock (solo si estamos en el panel egreso)
  const startBtn = document.getElementById('start-scanner-btn');
  const readerDiv = document.getElementById('qr-reader');
  const resultsDiv = document.getElementById('qr-reader-results');
  let scanner = null;

  if (startBtn) {
      startBtn.addEventListener('click', function () {
        // --- CASO: DETENER ESC츼NER ---
        if (scanner) {
          stopScanner();
          return;
        }

        // --- CASO: INICIAR ESC츼NER ---
        startBtn.innerHTML = '<i class="fas fa-stop fa-2x"></i><br>Detener Esc치ner';
        startBtn.classList.remove('btn-success');
        startBtn.classList.add('btn-danger');
        readerDiv.style.display = 'block';
        resultsDiv.innerHTML = '<div class="alert alert-info"><i class="fas fa-spinner fa-spin"></i> Iniciando c치mara...</div>';

        const config = { 
            fps: 10, 
            qrbox: { width: 250, height: 250 },
            aspectRatio: 1.0
        };

        scanner = new Html5QrcodeScanner("qr-reader", config, false);

        scanner.render(onScanSuccess, onScanFailure);
      });
  }

  // FUNCI칍N: 칄XITO AL LEER (Cualquier QR)
  function onScanSuccess(decodedText, decodedResult) {
      // 1. Intentar extraer el ID
      let pedidoId = null;
      const urlMatch = decodedText.match(/pedido\/(\d+)/);      
      if (urlMatch) {
        pedidoId = urlMatch[1];
      } else if (!isNaN(decodedText) && decodedText.trim().length > 0) {
        pedidoId = decodedText; // Es solo n칰meros
      }

      // 2. Si NO es un ID v치lido, mostramos error pero seguimos escaneando (o pausamos)
      if (!pedidoId) {
          resultsDiv.innerHTML = `
            <div class="alert alert-warning role="alert">
                <i class="fas fa-exclamation-triangle"></i> QR Le칤do: "${decodedText}" <br> 
                <strong>No parece ser un pedido v치lido.</strong> Intenta de nuevo.
            </div>`;
          return; // Salimos, el esc치ner sigue activo para buscar otro
      }

      // 3. Si ES un ID v치lido -> DETENEMOS TODO Y PROCESAMOS
      if (scanner) {
          scanner.clear().then(() => {
              scanner = null;
              readerDiv.style.display = 'none';
              startBtn.style.display = 'none'; // Ocultamos bot칩n para evitar doble clic
              
              // FEEDBACK VISUAL INMEDIATO
              resultsDiv.innerHTML = `
                <div class="card text-center shadow">
                    <div class="card-body">
                        <h4 class="text-primary"><i class="fas fa-check-circle"></i> Pedido #${pedidoId} Detectado</h4>
                        <p class="lead">Procesando salida de stock...</p>
                        <div class="spinner-border text-primary" role="status"></div>
                    </div>
                </div>
              `;

              // PROCESAR EN SERVIDOR
              enviarAlServidor(pedidoId);
          });
      }
  }

  // FUNCI칍N: ERROR DE LECTURA (Ocurre mucho mientras busca, mejor ignorar o loguear poco)
  function onScanFailure(error) {
      // No hacer nada visual aqu칤 para no saturar al usuario
      // console.warn(`Code scan error = ${error}`);
  }

  // FUNCI칍N AUXILIAR: ENVIAR DATOS
  function enviarAlServidor(pedidoId) {
      fetch("{% url 'completar_pedido_qr' %}", {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: new URLSearchParams({
            'form_type': 'completar_pedido',
            'pedido_id': pedidoId
        })
      })
      .then(response => response.json())
      .then(data => {
          if (data.success) {
              // 칄XITO: MOSTRAR MENSAJE VERDE Y LUEGO RECARGAR
              resultsDiv.innerHTML = `
                <div class="alert alert-success text-center py-5">
                    <h1><i class="fas fa-check-circle"></i></h1>
                    <h3>춰칄xito!</h3>
                    <p>${data.message}</p>
                    <p>Recargando...</p>
                </div>`;
              setTimeout(() => location.reload(), 2000); // Espera 2 seg y recarga
          } else {
              // ERROR DE L칍GICA (Ej: Stock insuficiente): MOSTRAR ROJO
              mostrarErrorYReiniciar(`Error: ${data.message}`);
          }
      })
      .catch(error => {
          // ERROR DE RED
          mostrarErrorYReiniciar("Error de conexi칩n con el servidor.");
      });
  }

  // FUNCI칍N AUXILIAR: DETENER
  function stopScanner() {
      if(scanner) {
          scanner.clear().then(() => {
            scanner = null;
            readerDiv.style.display = 'none';
            resultsDiv.innerHTML = '';
            startBtn.innerHTML = '<i class="fas fa-camera fa-2x"></i><br>Iniciar Esc치ner QR';
            startBtn.classList.remove('btn-danger');
            startBtn.classList.add('btn-success');
          });
      }
  }

  // FUNCI칍N AUXILIAR: MOSTRAR ERROR Y PERMITIR REINTENTAR
  function mostrarErrorYReiniciar(mensaje) {
      resultsDiv.innerHTML = `
        <div class="alert alert-danger text-center">
            <h4><i class="fas fa-times-circle"></i> Ocurri칩 un problema</h4>
            <p>${mensaje}</p>
            <button class="btn btn-outline-danger mt-3" onclick="location.reload()">
                <i class="fas fa-redo"></i> Recargar p치gina
            </button>
        </div>`;
  }

});

   

// Funci칩n para descargar reportes en PDF (fuera del DOMContentLoaded)
function downloadReport(id, tipo) {
    const element = document.getElementById('report-content-' + id);
    if (!element || typeof html2pdf === 'undefined') {
        alert("Error: No se pudo generar el PDF");
        return;
    }

    const fecha = new Date().toISOString().slice(0,10);
    const filename = `Reporte_${tipo}_${fecha}.pdf`;

    html2pdf().from(element).set({
        margin: [0.5, 0.8, 0.8, 0.8],
        filename: filename,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2, useCORS: true },
        jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
    }).save();
}

// Manejo del sidebar en dispositivos m칩viles
document.addEventListener('DOMContentLoaded', function() {
  // Crear elementos para m칩vil
  const mobileHeader = document.createElement('div');
  mobileHeader.className = 'mobile-header';
  mobileHeader.innerHTML = `
    <div class="mobile-header-content">
      <button class="mobile-menu-btn" id="mobile-menu-toggle">
        <i class="fas fa-bars"></i>
      </button>
      <h3>OceanAlgae - Almac칠n</h3>
      <div style="width: 48px;"></div> <!-- Espaciador -->
    </div>
  `;
  
  const sidebarOverlay = document.createElement('div');
  sidebarOverlay.className = 'sidebar-overlay';
  sidebarOverlay.id = 'sidebar-overlay';
  
  // Insertar elementos en el DOM
  document.body.insertBefore(mobileHeader, document.body.firstChild);
  document.body.appendChild(sidebarOverlay);
  
  // Referencias a elementos
  const sidebar = document.getElementById('sidebar');
  const mobileMenuToggle = document.getElementById('mobile-menu-toggle');
  const sidebarOverlayEl = document.getElementById('sidebar-overlay');
  
  // Funci칩n para abrir/cerrar sidebar
  function toggleSidebar() {
    sidebar.classList.toggle('active');
    sidebarOverlayEl.classList.toggle('active');
    document.body.style.overflow = sidebar.classList.contains('active') ? 'hidden' : '';
  }
  
  // Event listeners
  if (mobileMenuToggle) {
    mobileMenuToggle.addEventListener('click', toggleSidebar);
  }
  
  if (sidebarOverlayEl) {
    sidebarOverlayEl.addEventListener('click', toggleSidebar);
  }
  
  // Cerrar sidebar al hacer clic en un bot칩n (en m칩vil)
  const sidebarBtns = document.querySelectorAll('.sidebar-btn');
  sidebarBtns.forEach(btn => {
    btn.addEventListener('click', function() {
      if (window.innerWidth < 992) {
        toggleSidebar();
      }
    });
  });
  
  // Detectar cambios de tama침o de ventana
  let resizeTimer;
  window.addEventListener('resize', function() {
    clearTimeout(resizeTimer);
    resizeTimer = setTimeout(function() {
      if (window.innerWidth >= 992) {
        sidebar.classList.remove('active');
        sidebarOverlayEl.classList.remove('active');
        document.body.style.overflow = '';
      }
    }, 250);
  });
});

</script>

